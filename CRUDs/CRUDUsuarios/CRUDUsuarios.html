<!DOCTYPE html>
<!--



la parte funcional y logica de este crud esta completada. falta validación de datos del lado del backend     


    
-->

<!------CRUD de usuarios------>
<!--documentacion//changelog-->

<!--16/8-->

<!------Cambios al programa------>
<!--implementada la funcion para dar de alta una fila-->
<!--implementada la funcion para editar una fila-->
<!--implementada la funcion para leer la tabla por el campo "nombre_completo"-->
<!-- Ahora la tabla se recarga al dar de alta  
    Nota: se recarga bajo los datos enviados en la variable "l" en la funcion "cargarTabla()"-->


<!------Cambios a la interfaz------>
<!-- cambios a las etiquetas th y td para que se puedan completar con los datos de la tabla usuarios  -->
<!-- cambios a las etiquetas label de "myModal", "MmdalEdit" y "MmdalDelete" para que sean iguales a los campos de la tabla usuarios  -->
<!-- cambios a los parametros id y name de los input de "myModal", "MmdalEdit" y "MmdalDelete" para implementar las funciones correspondientes a cada uno  -->

<!------Cambios a la estructura del codigo------>
<!-- ahora la funcion que carga la tabla (Junto a las funcionalidades de Editar y Eliminar) esta declarada como "function cargarTabla()".
Permitiendo llamar esa funcion en cualquier parte del codigo para cargar o recargar la tabla sin que sea necesario copiar y pegar las 125 lineas de codigo de la funcion entera  -->

    
<!--18/8-->

<!------Cambios al programa------>
<!--17: 31-->
<!--implementada la funcion para dar de baja una fila-->
<!--23: 26-->
<!--modalUD ahor se oculta al dar de baja o alta-->
<!--23: 06-->
<!--solucionado error en el que las consultas de ajax a "DeleteUsuarios.php" y "RenameUsuarios.php" se repetian en bucle causando que el alerta que 
    confirma si los fueron elminados o editados con exito se repita el numero de veces que se hacia click en los botones de editar y/o borrar-->
<!--23: 26-->
<!-- Ahora la tabla se recarga al dar de baja o editar 
    Nota: se recarga bajo los datos enviados en la variable "l" en la funcion "cargarTabla()"-->

<!------Cambios a la interfaz------>
<!--19: 53-->
<!-- La funcionalidad de dar de baja y editar datos ahora usan el mismo formulario en el mismo modal -->

<!------Cambios a la estructura del codigo------>
<!--15: 46-->
<!--La funcionalidad de editar datos fue agregada en una funcion declarada como "loadFormedit()"" -->
<!--el array json recibido de "BackendUsuarios.php" ahora se convierte en array de JUDaScript mediante la funcion JSON.parse y se guarda en la variable "box" -->
<!--17: 31-->
<!--La funcionalidad de eliminar datos fue agregada en una funcion declarada como "cargarFormDelete()" -->
<!--23: 06-->
<!--consultas de ajax a "DeleteUsuarios.php" y "RenameUsuarios.php" agregadas a las funciones declaradas como "confirmEdit()" y "confirmDelete()"
    Esto permite solucionar error en el que las consultas de ajax se repetien el numero de veces que se hacia click en los botones de editar y/o borrar-->

    
<!--19/8-->

<!------Cambios al programa------>
<!--16: 30-->
<!-- Ahora al dar de alta o editar se muestra el registro en la tabla-->

<!------Cambios a la interfaz------>
<!--18: 50-->
<!-- ahora se puede cambiar la forma en la que se organiza la informacion de los registros al cargar la tabla -->

<!------Cambios a la estructura del codigo------>
<!--15: 21-->
<!--las funciones "confirmEdit()" y "confirmDelete()" ahora guardan el formulario para editar o borrar en un array utilizando ").serializeArray(" -->


<!--23/8-->

<!------Cambios al programa------>
<!--17: 02-->
<!--Funcionalidad para validar datos (incompleto)-->

<!------Cambios a la interfaz------>
<!--Sin cambios-->

<!------Cambios a la estructura del codigo------>
<!--17: 25-->
<!--se corrigio la nomenclatura en los parametros "name" y "id" los formularios-->


<!--24/8-->

<!------Cambios al programa------>
<!--12: 02-->
<!--Funcionalidad para validar datos impementada (incompleto)-->
<!--18: 03-->
<!--Funcionalidad para validar datos completada e impelmentada en la funcionalidad de alta y editar-->

<!------Cambios a la interfaz------>
<!--10: 53-->
<!--Se agrego el atributo "data-bs-backdrop='static'" a ambos modales. esto evita que se cierren al hacer click en otra parte de la pantalla que no se el modal -->
<!--11: 04-->
<!--Ahora se indica con un alert que deatos no son validos al intentar dar de alta-->
<!--22: 14-->
<!--ahora el input de los dni es d numerico. esto solucina error que te permitia ingrsar letras en el dni-->


<!--25/8-->

<!------Cambios a la interfaz------>
<!--22: 04-->
<!--se agregaron mas clases de bootstrap a las tablas-->


<!--26/8-->

<!------Cambios al programa------>
<!--09: 06-->
<!--se agregaro una funcionalidad para filtrar la tabla por tipo de usuario-->


<!--27/8-->

<!------Cambios al programa------>
<!--21: 45-->
<!--ahora todas las consultas de ajax a 'BackendUsuarios.php' se envian con el dato "funcion" para definir mediante un 'if()' que funcion/es SQL se desea ejecutar-->
<!--22: 23-->
<!--ahora al dar de alta se envia en un array el dni y el email para hacer una consulta a la base de datos, en la que los registros consultados coincidan con los datos enviados. 
    si ambos datos tiene un registro que coincida se reciben en formato JSON y se convierte en array [0{dni: "registro que coincide"},1{email: "registro que coincide"}].
    si solamente uno de los registros coincide entonces el valor de de 'email' o 'dni' será 0 en vez de "registro que coincide"-->

<!--31/8-->

<!------Cambios al programa------>
<!--20:25-->
<!--las funciones 'confirmADdd()', 'validarDatos()' y 'validarRepetidos()' ahora son asincronas para guardar su resultado (true o false) en una variable.
    esto evita que al llamarlas con un if este las tome como false antes de que la funcion termine -->


<!--01/9-->

<!------Cambios al programa------>
<!--21:45-->
<!-- implementada funcionalidad para filtrar por DNI. 
si se ingresa un dni que no existe no se carga ningun registro en la tabla-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <title>Document</title>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col">
                  <h1>Consulta a base de datos</h1>      
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-2">
                <input class="form-control altura" type="text" id="ordenarNomb" placeholder="Buscar Nombre">
            </div>
            <div class="col-3">
                <input class="form-control altura" type="number" id="ordenarDniTxt" placeholder="filtrar por DNI">
            </div>
            <div class="col-2">
                <select class="form-control altura" id="orderBy" value="0" placeholder="ordenar por">
                    <option class="form-control altura" value="0">Ordenar por...</option>
                    <option class="form-control altura" value="1">DNI ↑</option>
                    <option class="form-control altura" value="2">DNI ↓</option>
                    <option class="form-control altura" value="3">Id ↑</option>
                    <option class="form-control altura" value="4">Id ↓</option>
                </select>
            </div>
            <div class="col-2">
                <select class="form-control altura" id="readByTipo" value="0" placeholder="ordenar por">
                    <option class="form-control altura" value="0">Tipo de usuario</option>
                    <option class="form-control altura" value="1">Administrador</option>
                    <option class="form-control altura" value="2">Usuario</option>
                </select>
            </div>
            <div class="col-2">
                <button id="botonModal" type="button" class="btn text-center btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">+</button>
            </div>
                 <!-- The Modal -->
                <div class="modal fade" data-bs-backdrop="static" id="myModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                        
                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title" >Añadir datos</h4>
                                <button id="closeModal(1)" type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                        
                            <!-- Modal body -->
                            <div class="container"> 
                                <form id="formAdd">
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Nombre Completo</label>
                                                <input name="nombreCompleto" type="text" id="nombreCompleto" min="0" max="255" placeholder="" class="form-control">        
                                            </div>
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">DNI</label>
                                                <input name="dni" type="number" id="dni" min="0" max="11" placeholder="" class="form-control">        
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Email</label>
                                                <input name="email" type="text" id="email" min="0" max="255" placeholder="" class="form-control">        
                                            </div>
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Contraseña</label>
                                                <input name="contraseña" type="text" id="contrasenna" min="0" max="255" class="form-control">       
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col">                                        
                                                <label for="texto de ejemplo" class="form-label">Tipo de usuario</label>
                                                <input name="tipoUsuario" type="text" id="tipoUsuario" min="0" max="1" placeholder="" class="form-control">        
                                            </div>    
                                        </div>
                                    </div>
                                </form>    
                            </div>

                            <!-- Modal footer -->
                        <div class="modal-footer">
                            <button id="closeModal2(1)" type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                            <button id="addData" type="button" class="btn btn-primary xd">enviar</button>
                        </div>        
                    </div>
                </div>      
            </div>    
        </div>
        <div class="row">
            <div class="col">   
                <table class="table table-bordered table-hover table-striped table-sm">
                    <thead>
                        <tr>
                            <th class='xd'>Acciones</th>
                            <th class='xd'>ID usuarios</th>
                            <th class='xd'>Nombre Completo</th>
                            <th class='xd'>Email</th>
                            <th class='xd'>DNI</th>
                            <th class='xd'>Contraseña</th>
                            <th class='xd'>Tipo de usuario</th>
                            <!-- th class='xd'>Datos Personales</th -->
                        </tr>
                    </thead>
                    <tbody  id="tabla1">
                       
                    </tbody>
                </table>    
            </div>
            <!--<div class="col-2">-->
                <!-- The Modal -->
                <div class="modal fade" data-bs-backdrop="static" id="modalUD">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form id="formUD">
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <div class="col-5">
                                        <h4 class="modal-title" id="tituloUD">Editar datos</h4>
                                    </div>
                                    <div class="col-2">
                                        <label>id</label><input type="text" class="form-control" name="idUD" id="idUD" readonly>
                                    </div>
                                    <div class="col-5 text-end">  
                                        <button id="closeModalUD" type="button" onclick="" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                </div>
                        
                                <!-- Modal body -->
                                <div class="container"> 
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Nombre Completo</label>
                                                <input name="nombreCompletoUD" min="0" max="255" type="text" id="nombreCompletoUD" placeholder=""  class="form-control">        
                                            </div>
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">DNI</label>
                                                <input name="dniUD" type="number" id="dniUD" min="0" max="11" placeholder="" class="form-control"> 
                                            </div>       
                                        </div>
                                        <div class="row">
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Email</label>
                                                <input name="emailUD" type="text" min="0" max="255" id="emailUD" placeholder="" class="form-control">        
                                            </div>
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Contraseña</label>
                                                <input name="contrasennaUD" type="text" min="0" max="255" id="contrasennaUD"  class="form-control">       
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">                                        
                                                <label for="texto de ejemplo" class="form-label">Tipo de usuario</label>
                                                <input name="tipoUsuarioUD" type="text" min="0" max="1" id="tipoUsuarioUD" placeholder="" class="form-control">        
                                            </div>    
                                        </div>
                                    </div>
                                </div>
                            </form>  
                            <!-- Modal footer -->
                            <div class="modal-footer">
                                <button id="closeModalUD2" type="button" class="btn btn-danger"  data-bs-dismiss="modal">Cancelar</button>
                                <button id="editData" type="button" class="btn btn-primary xd" >enviar</button>
                                <button id="deleteData" type="button" class="btn btn-danger xd" >eliminar</button>
                            </div>        
                        </div>
                    </div>  
                </div>
            <!--</div>-->
        </div>
    </div>
</body>
</html>

<script>

$(document).ready(function()
{
    
    async function confirmAdd()
    {
    var datos = $('#formAdd').serializeArray();
    
    var validcion = await validarDatos(datos) 
    if (validcion == true) 
    {
        console.log("validacion exitosa")
        $.ajax({
            type:"POST",    
            url:"addUsuarios.php",
            data: datos,
            success:function(r){
                if(r == 1)
                {
                    alert("agregado con exito");
                    $("#ordenarNomb").val(nombreCompleto.value)
                    cargarTabla();
                    $("#myModal").modal('hide')
                }else
                {
                    alert("Fallo");
                }
            }
        })
    }
    else
    {
        console.log("algo anda mal")
    }  
    }
    $("#addData").on("click", function(){confirmAdd() }) 

    async function validarDatos(datos)
    {
        var valido = true
    
        if(datos[0].value.length == 0 || datos[0].value.length > 255)
        {   
            alert("Nombre no valido")
            //console.log("Nombre completo no valido",datos[0].value.length)
            valido = false
            return valido;
        }
        else
        {
            //console.log("Nombre completo valido",datos[0].value, datos[0].value.length)
            if(datos[1].value < 9999999 || datos[1].value > 100000000)
            { 
                alert("DNI no valido")
                //console.log("dni no valido",datos[1].value.length)
                valido = false
                return valido;
            }
            else
            {
                //console.log("dni valido", datos[1].value.length)
                if(datos[2].value.length == 0 || datos[2].value.length > 255)
                {
                    alert("Correo eletronico no valido")
                    //console.log("email no valido",datos[2].value.length)
                    valido = false
                    return valido;
                }
                else
                {
                    //console.log("email valido",datos[2].value.length)
                    if(datos[3].value.length == 0 || datos[3].value.length > 255)
                    {
                        alert("Contraseña no valida")
                        //console.log("contraseña no valida",datos[3].value.length)
                        valido = false
                        return valido;
                    }
                    else
                    {
                        //console.log("contraseña valida",datos[3].value.length)
                        if(datos[4].value != "A" && datos[4].value != "U"  || datos[4].value.length == 0 || datos[4].value.length > 1)
                        {
                            alert("Tipo de usuario no valido")
                            //console.log("tipo de usuario no valido",datos[4].value.length)
                            valido = false
                            return valido;
                        }
                        else
                        {
                            x = await validarRepetidos(datos)
                            console.log("Await:", x)
                            if(x == false)
                            {
                                alert("dni o email ya registrado")
                                valido = false
                                return valido;
                                
                            }
                            else
                            {
                                return valido;
                                //console.log("tipo de usuario valida",datos[4].value.length)
                            }
                        }
                    }
                }
            }
        } 
    }

    function confirmEdit()
    {
    var editarDatos = $("#formUD").serializeArray();
        var datos = [editarDatos[1], editarDatos[2], editarDatos[3], editarDatos[4], editarDatos[5]] 
        
        if(validarDatos(datos))
        {
            $.ajax({
            url: "RenameUsuarios.php",
            type: "POST",
            data: editarDatos,
            success: function(r)
            {
                if (r == 1) 
                    {

                    alert("datos modificados con exito")
                    $("#ordenarNomb").val(nombreCompletoUD.value)
                    cargarTabla()
                    $("#modalUD").modal('hide')

                    }
                }
            })
        }
        else
        {
            console.log("algo anda mal")
        }
    }

    function confirmDelete()
    {
        var eliminarDatos = $("#formUD").serializeArray();
        //console.log("editarDatos: ", eliminarDatos)
        $.ajax({
        url: "DeleteUsuarios.php",
        type: "POST",
        data: eliminarDatos,
        success: function(r){
            if (r == 1) 
                {
                
                alert("datos Eliminados")
                cargarTabla()
                $("#modalUD").modal('hide')
                
                }
            }
        })
    }

    $("#editData").on("click", function(){confirmEdit() }) 
    $("#deleteData").on("click", function(){confirmDelete()}) 

    function cargarFormEdit(value)
    {
        $('#tituloUD').text('Editar Datos')
        $("#editData").show()
        $("#deleteData").hide()
        
        $("#idUD").val(value.id_usuario)
        $("#idUD").attr('placeholder', value.id_usuario) 
        
        $("#nombreCompletoUD").val(value.nombre_completo)
        $("#nombreCompletoUD").attr('placeholder', value.nombre_completo) 
        $("#nombreCompletoUD").attr('readonly', false)
        
        $("#dniUD").val(value.dni)
        $("#dniUD").attr('placeholder', value.dni) 
        $("#dniUD").attr('readonly', false)
        
        $("#emailUD").val(value.email)
        $("#emailUD").attr('placeholder', value.email) 
        $("#emailUD").attr('readonly', false)
        
        $("#contrasennaUD").val(value.contrasenna)
        $("#contrasennaUD").attr('placeholder', value.contrasenna) 
        $("#contrasennaUD").attr('readonly', false)
        
        $("#tipoUsuarioUD").val(value.tipo_usuario)
        $("#tipoUsuarioUD").attr('placeholder', value.tipo_usuario) 
        $("#tipoUsuarioUD").attr('readonly', false)
    }

    function cargarFormDelete(value)
    {
        $('#tituloUD').text('Eliminar Datos')
        $("#deleteData").show()
        $("#editData").hide()

        $("#idUD").val(value.id_usuario)
        $("#idUD").attr('placeholder', value.id_usuario) 
        
        $("#nombreCompletoUD").val(value.nombre_completo)
        $("#nombreCompletoUD").attr('placeholder', value.nombre_completo) 
        $("#nombreCompletoUD").attr('readonly', true)
        
        $("#dniUD").val(value.dni)
        $("#dniUD").attr('placeholder', value.dni) 
        $("#dniUD").attr('readonly', true)
        
        $("#emailUD").val(value.email)
        $("#emailUD").attr('placeholder', value.email) 
        $("#emailUD").attr('readonly', true)
        
        $("#contrasennaUD").val(value.contrasenna)
        $("#contrasennaUD").attr('placeholder', value.contrasenna) 
        $("#contrasennaUD").attr('readonly', true)
        
        $("#tipoUsuarioUD").val(value.tipo_usuario)
        $("#tipoUsuarioUD").attr('placeholder', value.tipo_usuario) 
        $("#tipoUsuarioUD").attr('readonly', true)

    }

    async function validarRepetidos(array)
    {   
        var noRepetido = false

        var dni = array[1].value
        var email = array[2].value
        console.log("dni y email", dni, email)
        
        var ajax = $.ajax({
            url: "BackendUsuarios.php", //action
            type: "POST", //method
            data: {"funcion": 2, "dni": dni, "email": email},
            success: 
            function(respuesta){
                let check = true
                var box = JSON.parse(respuesta)
            }
        })
        await ajax 
        const result = await ajax 

        var box = JSON.parse(result)
        
        var dniAjax = box[0].dni
        var emailAjax = box[1].email

        if(dniAjax == dni)
        {
            console.log("dni repetido")
            noRepetido = false  
            return noRepetido;
        }
        else
        {   
            if(emailAjax == email)
            {
                console.log("email repetido")
                noRepetido = false  
                return noRepetido;
            }
            else
            {
                console.log("datos no repetidos")
                noRepetido = true  
                return noRepetido;
            }     
        }
    }

    function cargarTabla()
    {   
        $("#tabla1").empty()
        var dni = $('#ordenarDniTxt').val()
        var opt = $("#orderBy").val()
        var read = $("#readByTipo").val()
        var l = $("#ordenarNomb").val()
        if (l != ""){
            //console.log("if")
            $.ajax({
    
            url: "BackendUsuarios.php", //action
            type: "POST", //method
            data: {"funcion": 0, "letra": l, "opcion": opt, "filtro": read, "dni": dni}, 
            //dataType: "json",
            success: function(respuesta){
                console.log(respuesta)
                var box = JSON.parse(respuesta) 
                console.log("datos cargados:",box)

                $.each(box, function(key, value){
                    //console.log("Respuesta: " + respuesta)
                    //console.log("Key: " , key)
                    //console.log("Value: " , value)

                    $("#tabla1").append("<tr id='fila"+key+"'  >"+
                    "<td class='xd xdwidth'>"+
                    "<div class='btn-group' role='group' aria-label='Basic example'>"+
                        "<button class='btn btn-sm btn-secondary text-center' id='edit"+key+"' data-bs-toggle='modal' data-bs-target='#modalUD'>"+
                            "<img class='iconsize' src='../../iconos/edit-3.svg'>"+
                        "</button>"+
                        "<button class='btn btn-sm btn-danger text-center' id='delete"+key+"' data-bs-toggle='modal' data-bs-target='#modalUD'>"+
                            "<img class='iconsize' src='../../iconos/trash-2.svg'>"+
                        "</button>"+
                    "</div>"+
                    "</td>"+
                    "<td class='xd'>"+value.id_usuario+"</td>"+
                    "<td class='xd'>"+value.nombre_completo+"</td>"+
                    "<td class='xd'>"+value.email+"</td>"+
                    "<td class='xd'>"+value.dni+"</td>"+
                    "<td class='xd'>"+value.contrasenna+"</td>"+
                    "<td class='xd'>"+value.tipo_usuario+"</td>"+
                    "</tr>") 
                    
                    $("#edit"+key).on("click", function(){
                        //console.log(value)
                        cargarFormEdit(value)
                    })

                    $("#delete"+key).on("click", function(){
                        //console.log(value)
                        cargarFormDelete(value)
                    })
                    
                    key = key + 1
                    
                    })
                }
            })
        }
    }

    $("#orderBy").change(function(){
        cargarTabla();
    })

    $("#ordenarNomb").keyup(function(){
        cargarTabla();
    })

    $("#ordenarDni").click(function(){
        cargarTabla();
    })

    $("#readByTipo").change(function(){
        cargarTabla();
    })
})

</script>
<style>
.sex
{
    border: solid, red;
}

.xd
{
    text-align: center;
}

.iconsize
{
    height: 30px;
    width: 30px;
}

.altura
{
    height: 40px;
}

/*oculta las flechas del input Type=number*/
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button 
{
  -webkit-appearance: none;
  margin: 0;
}

/*oculta las flechas del input Type=number en firefox*/
input[type=number] 
{
  -moz-appearance: textfield;
}

</style>